<script>
  (function () {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –ø—Ä–∞–≤–¥–∞ –≤–Ω—É—Ç—Ä–∏ Telegram
    const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;

    // –ü–ª–∞—à–∫–∞-–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤–Ω–∏–∑—É
    const diag = document.createElement('div');
    diag.style.position = 'fixed';
    diag.style.left = '12px';
    diag.style.right = '12px';
    diag.style.bottom = '12px';
    diag.style.fontSize = '12px';
    diag.style.opacity = '0.7';
    diag.textContent = tg ? 'WebApp OK' : 'WebApp NOT DETECTED ‚Äî –æ—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ Telegram';
    document.body.appendChild(diag);

    if (tg) {
      tg.ready();
      try { tg.expand(); } catch(_) {}
    }

    const btn = document.getElementById('submit');
    btn.setAttribute('type', 'button');

    btn.addEventListener('click', () => {
      if (!tg) {
        alert('–°—Ç—Ä–∞–Ω–∏—Ü—É –Ω—É–∂–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ Telegram, –Ω–µ –≤ –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.');
        return;
      }
      const selected = document.querySelector('input[name="color"]:checked');
      const val = selected ? selected.value : 'white';

      // –í–∏–±—Ä–æ/–≤–∏–∑—É–∞–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫
      try { tg.HapticFeedback && tg.HapticFeedback.impactOccurred('medium'); } catch(_) {}

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —á–∞—Ç
      tg.sendData(JSON.stringify({ color: val }));

      // (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ
      try { tg.close(); } catch(_) {}

      // (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –ø–æ–ø-–∞–ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
      try { tg.showPopup({ title: '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', message: '–í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ –ø–µ—Ä–µ–¥–∞–Ω –±–æ—Ç—É.' }); } catch(_) {}
    });
  })();
</script>
@dp.message(F.web_app_data)
async def webapp_any_state(message: Message, state: FSMContext):
    import json
    try:
        payload = json.loads(message.web_app_data.data)
        color_raw = payload.get("color", "")
        color = BagColor(color_raw)
        await state.update_data(preset_color=color.value)
    except Exception:
        await message.answer("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≤—ã–±–æ—Ä –∏–∑ Mini App. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.")
        return

    data = await state.get_data()
    file_id = data.get("photo_file_id")

    if not file_id:
        # –§–æ—Ç–æ –µ—â—ë –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å–∏–º –µ–≥–æ
        await message.answer("–¶–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω–∏–ª ‚úÖ –¢–µ–ø–µ—Ä—å –ø—Ä–∏—à–ª–∏ —Ñ–æ—Ç–æ (–∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ), –∏ —è —Å–≥–µ–Ω–µ—Ä–∏—Ä—É—é.")
        await state.set_state(GenStates.waiting_photo)
        return

    # –§–æ—Ç–æ —É–∂–µ –µ—Å—Ç—å ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å—Ä–∞–∑—É
    try:
        photo_bytes = await download_telegram_file(message.bot, file_id)
        gen_bytes = await call_flow_api(photo_bytes, color, message.from_user.id)
    except Exception:
        gen_bytes = None

    if not gen_bytes:
        await message.answer("üòî –ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ –∏–ª–∏ –ø—Ä–∏—à–ª–∏ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ. /start")
        await state.clear()
        return

    await message.answer_photo(photo=gen_bytes, caption="–ì–æ—Ç–æ–≤–æ! –ï—â—ë –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî /start")
    await state.clear()
